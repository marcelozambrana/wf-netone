<ion-header>
  <ion-navbar>
    <ion-title>{{pedido.numero ? 'Pedido' : 'Novo Pedido' }}</ion-title>

    <ion-buttons end>
      <button ion-button icon-only (click)="adicionarItemPedido()" *ngIf="passo==4 && !pedido.enviado">
        <ion-icon name="paper"></ion-icon>
      </button>
      <button ion-button icon-only (click)="adicionarCliente()" *ngIf="passo==1 && !pedido.enviado">
        <ion-icon name="person-add"></ion-icon>
      </button>
    </ion-buttons>
  </ion-navbar>
</ion-header>


<ion-content class="pedido-content">

  <form padding [formGroup]="pedidoForm" novalidate>

    <div *ngIf="passo==1 || passo==2">

      <h6>Cliente do Pedido</h6>
      <ion-list inset>

        <ion-item *ngIf="clientFound">
          <ion-icon name="md-person" item-start></ion-icon>
          <h2>{{pedido.cliente.nome}}</h2>
          <h3>{{pedido.cliente.cpfCnpj}}</h3>
        </ion-item>
        
        <ion-item *ngIf="!clientFound">
          <ion-label floating>CPF/CNPJ</ion-label>
          <ion-input type="text" [brmasker]="{person: true}" formControlName="cliente" (ionBlur)="onBlurCpfCnpj($event.value)" [(ngModel)]="pedido.cliente" [disabled]="passo!=1"></ion-input>
        </ion-item>
        
        <button *ngIf="passo==1 && !clientFound" ion-button block (click)="selecionaClienteEContinua()">Buscar Cliente</button>
        <button *ngIf="passo==1 && clientFound" ion-button block (click)="selecionaClienteEContinua()">Continuar</button>
      </ion-list>

      <!-- <h6 *ngIf="clientSearch && !clientFound" class="warning"> {{mensagemClienteNaoEncontrado}}</h6> -->
    </div>


    <div *ngIf="passo==2">

      <h6>Dados gerais</h6>
      <ion-list inset>
        <ion-item>
          <ion-label floating>Emissão</ion-label>
          <ion-datetime disabled displayFormat="DD/MM/YYYY" pickerFormat="DD/MM/YYYY" formControlName="dataEmissao" [(ngModel)]="pedido.emissao"></ion-datetime>
        </ion-item>

        <ion-item>
          <ion-label floating>Previsão de Entrega</ion-label>
          <ion-datetime displayFormat="DD/MM/YYYY" pickerFormat="DD/MM/YYYY" formControlName="dataPrevisaoEntrega" [(ngModel)]="pedido.previsaoEntrega"></ion-datetime>
        </ion-item>

        <button ion-button block (click)="selecionaDadoCobrancaEContinua()">Continuar</button>
      </ion-list>

      <!-- <h6 *ngIf="mensagemDadosCobrancaNaoPreenchidos != ''" class="warning"> {{mensagemDadosCobrancaNaoPreenchidos}}</h6> -->
    </div>


    <div *ngIf="passo==10">

      <h6>Dados para entrega</h6>
      <ion-list inset>

        <ion-item>
          <ion-label floating>Logradouro</ion-label>
          <ion-input type="text" formControlName="logradouro" disabled [(ngModel)]="pedido.cliente.endereco.logradouro"></ion-input>
        </ion-item>

        <ion-item>
          <ion-label floating>Nº</ion-label>
          <ion-input type="text" formControlName="numero" disabled [(ngModel)]="pedido.cliente.endereco.numero"></ion-input>
        </ion-item>

        <ion-item>
          <ion-label floating>Complemento</ion-label>
          <ion-input type="text" formControlName="complemento" disabled [(ngModel)]="pedido.cliente.endereco.complemento"></ion-input>
        </ion-item>

        <ion-item>
          <ion-label floating>CEP</ion-label>
          <ion-input type="number" maxlength="8" formControlName="cep" disabled [(ngModel)]="pedido.cliente.endereco.cep"></ion-input>
        </ion-item>

        <ion-item>
          <ion-label floating>Bairro</ion-label>
          <ion-input type="text" formControlName="bairro" disabled [(ngModel)]="pedido.cliente.endereco.bairro"></ion-input>
        </ion-item>

        <ion-item>
          <ion-label floating>Cidade</ion-label>
          <ion-input type="text" formControlName="cidade" disabled [(ngModel)]="pedido.cliente.endereco.cidade"></ion-input>
        </ion-item>

        <ion-item>
          <ion-label floating>UF</ion-label>
          <ion-input type="text" maxlength="2" formControlName="uf" disabled [(ngModel)]="pedido.cliente.endereco.uf"></ion-input>
        </ion-item>

      </ion-list>

      <button ion-button block color="danger" *ngIf="!pedido.enviado" (click)="cancelar()">Cancelar Pedido</button>
      <button ion-button block (click)="salvar()" *ngIf="!pedido.enviado"> Salvar</button>      
    </div>


    <div *ngIf="passo == 4">
      <ion-list inset>

        <h6>Produtos</h6>

        <p *ngIf="pedido.itens.length == 0">Nenhum produto adicionado</p>

        <ion-item *ngFor="let item of pedido.itens">
          <span item-start style="font-weight: bold; color: black">{{ item.nome }}</span>
          <span item-end style="font-weight: bold; color: black">Qtde: {{ item.quantidade}}</span>
          <button clear="" ion-button item-end icon-left *ngIf="!pedido.enviado" (tap)="tapAddQuantidade($event, item)">
            <ion-icon name="add-circle"></ion-icon>
          </button>

          <button clear="" ion-button item-end icon-left *ngIf="!pedido.enviado" (tap)="tapRemoveQuantidade($event, item)">
            <ion-icon name="remove-circle"></ion-icon>
          </button>
          <button clear="" ion-button item-end icon-left *ngIf="!pedido.enviado" color="danger" (click)="excluirItem(item)">
            <ion-icon name="trash"></ion-icon>
          </button>
        </ion-item>
      </ion-list>
    </div>

    <div *ngIf="passo==5">
      <ion-list inset>

        <h6>Dados de Pagamento</h6>
      
        <ion-item>
          <ion-label floating>Forma de Cobrança</ion-label>
          <ion-select formControlName="formaCobranca" [(ngModel)]="pedido.formaCobranca" [disabled]="pedido.enviado">
            <ion-option value="boleto">Boleto</ion-option>
            <ion-option value="cartaoDebito">Cartão Débito</ion-option>
            <ion-option value="cartaoCredito">Cartão Crédito</ion-option>
            <ion-option value="cheque">Cheque</ion-option>
            <ion-option value="dinheiro">Dinheiro</ion-option>
          </ion-select>
        </ion-item>

        <ion-item>
          <ion-label floating>Condição Pagamento</ion-label>
          <ion-select formControlName="condicaoPagamento" [(ngModel)]="pedido.condicaoPagamentoId" [disabled]="pedido.enviado">
            <ion-option value="{{condicao.id}}" *ngFor="let condicao of condicoes | async">{{condicao.descricao}}</ion-option>
          </ion-select>
        </ion-item>        

        <ion-item>
            <ion-label floating>(R$) Desconto total</ion-label>
            <ion-input type="number" [disabled]="!pedido.condicaoPagamentoId || !pedido.formaCobranca || pedido.enviado" formControlName="desconto" [(ngModel)]="pedido.descontoTotal"></ion-input>
          </ion-item>         
        
        <button ion-button block color="secondary" outline (click)="voltarAdicionarItens()">{{pedido.enviado ? 'Visualizar' : 'Alterar'}} Pedido</button>
        <button ion-button block color="danger" *ngIf="!pedido.enviado" (click)="cancelar()">Cancelar Pedido</button>
        <!-- <button ion-button block (click)="salvar()">Salvar</button> -->
        <button ion-button block  *ngIf="!pedido.enviado" (click)="exibirEndereco()">Continuar</button>        
      </ion-list>
    </div>

  </form>

</ion-content>

<ion-footer *ngIf="passo == 4 || passo == 10">
  <ion-toolbar>
    <!-- <ion-title>Valor Total: R$ 150,00</ion-title> -->
    
    <!-- <ion-list>
      <ion-item>
        <ion-badge color="secondary">Valor: R$ 150,00</ion-badge>
      </ion-item>
      <ion-item>
          <ion-badge color="secondary">Valor Total: R$ 150,00</ion-badge>
        </ion-item>      
    </ion-list> -->
    <!-- <p>Qtde: 15</p> -->

    <ion-list style="margin: 0;">
        <ion-item>
          <h2>Valor Total: R$ {{pedido.total | number}}</h2>
          <p>Qtde: {{qtdTotal | number}}</p>
        </ion-item>
      </ion-list>    
    

    <ion-buttons end *ngIf="passo == 10 || passo == 4">
      <ion-buttons>
        <button *ngIf="passo == 4" ion-button block (click)="resumoPedido()">Resumo Pedido</button>
        <button *ngIf="passo == 10" ion-button block (click)="salvar()">Finalizar Pedido</button>        
      </ion-buttons>
    </ion-buttons>    
    
  </ion-toolbar>
</ion-footer>